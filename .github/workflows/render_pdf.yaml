name: Render PDFs

on:
  push:
    branches: [main, master]
    paths:
      - 'qmd/**'
      - 'bib.bib'
      - 'apa.csl'

jobs:
  render-pdfs:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Setup Quarto
      uses: quarto-dev/quarto-actions/setup@v2
    
    # CACHE partag√© avec deploy.yml
    - name: Cache TinyTeX
      uses: actions/cache@v3
      id: cache-tinytex
      with:
        path: ~/.TinyTeX
        key: ${{ runner.os }}-tinytex-shared
        restore-keys: |
          ${{ runner.os }}-tinytex-
    
    # Installer seulement si pas dans cache OU si installation √©choue
    - name: Install or restore TinyTeX
      run: |
        echo "üîç V√©rification/Installation de TinyTeX..."
        
        # Si d√©j√† dans le cache, juste configurer le PATH
        if [ -d "$HOME/.TinyTeX" ]; then
          echo "‚úÖ TinyTeX trouv√© dans le cache"
          export PATH="$HOME/.TinyTeX/bin/x86_64-linux:$PATH"
          echo "$HOME/.TinyTeX/bin/x86_64-linux" >> $GITHUB_PATH
          which pdflatex || echo "pdflatex pas encore dans PATH"
          exit 0
        fi
        
        # Sinon, installer
        echo "üìÑ Installation de TinyTeX..."
        
        # 1. Installer avec un miroir sp√©cifique
        wget -qO- "https://yihui.org/tinytex/install-unx.sh" | sh
        
        # 2. Configurer PATH
        TEX_PATH="$HOME/.TinyTeX/bin/x86_64-linux"
        echo "$TEX_PATH" >> $GITHUB_PATH
        export PATH="$TEX_PATH:$PATH"
        
        # 3. Changer IMM√âDIATEMENT le d√©p√¥t avant toute op√©ration
        cd "$TEX_PATH"
        ./tlmgr option repository https://ftp.math.utah.edu/pub/texlive/tlnet
        
        # 4. Mettre √† jour SANS √©chec si version d√©synchronis√©e
        echo "üîÑ Mise √† jour tlmgr (ignorer les erreurs de version)..."
        set +e  # Ne pas s'arr√™ter sur erreur
        ./tlmgr update --self 2>&1 | grep -v "seems to be older" || true
        set -e  # R√©activer arr√™t sur erreur
        
        # 5. Installer les packages essentiels
        echo "üì¶ Installation des packages LaTeX..."
        for pkg in geometry hyperref fancyhdr sectsty microtype \
                   booktabs array pdfpages wrapfig float caption subcaption \
                   amsmath amsfonts amssymb; do
          ./tlmgr install "$pkg" 2>/dev/null || echo "Package $pkg: d√©j√† install√© ou erreur"
        done
        
        echo "‚úÖ TinyTeX install√©/pr√™t"
    
    - name: Verify LaTeX installation
      run: |
        echo "üîç V√©rification finale..."
        export PATH="$HOME/.TinyTeX/bin/x86_64-linux:$PATH"
        
        if command -v pdflatex &> /dev/null; then
          echo "‚úÖ pdflatex disponible"
          pdflatex --version | head -2
        else
          echo "‚ùå pdflatex NON trouv√©, tentative alternative..."
          # V√©rifier si binaire existe
          if [ -f "$HOME/.TinyTeX/bin/x86_64-linux/pdflatex" ]; then
            echo "pdflatex existe mais pas dans PATH, ajustement..."
            export PATH="$HOME/.TinyTeX/bin/x86_64-linux:$PATH"
            which pdflatex
          else
            echo "ERREUR: pdflatex absent, installation √©chou√©e"
            exit 1
          fi
        fi
    
    - name: Render PDFs
      run: |
        echo "üìÑ G√©n√©ration des PDFs..."
        
        # FORCER le PATH
        export PATH="$HOME/.TinyTeX/bin/x86_64-linux:$PATH"
        
        # V√©rifier
        which pdflatex || { echo "pdflatex introuvable"; exit 1; }
        echo "pdflatex version:"
        pdflatex --version | head -2
        
        # G√©n√©rer seulement les fichiers qui sp√©cifient format PDF
        for file in qmd/*.qmd; do
          if [[ -f "$file" ]]; then
            base=$(basename "$file" .qmd)
            echo "--- Rendu: $base ---"
            
            # Option: v√©rifier si le fichier contient 'format: pdf' ou 'pdf: default'
            if grep -q "format:.*pdf" "$file" || \
               grep -q "pdf:.*default" "$file" || \
               [[ "$base" == "test_stat" ]] || \
               [[ "$base" == "06-classical-tests" ]]; then
              
              echo "üìÑ Conversion en PDF..."
              quarto render "$file" --to pdf || \
                echo "‚ö†Ô∏è √âchec pour $base"
            else
              echo "‚è≠Ô∏è  $base: pas de format PDF sp√©cifi√©, ignor√©"
            fi
          fi
        done
        
        # R√©sum√©
        echo "üìä PDFs g√©n√©r√©s:"
        ls -la qmd/*.pdf 2>/dev/null || echo "Aucun PDF g√©n√©r√©"
    
    - name: Upload PDF artifacts
      uses: actions/upload-artifact@v4
      with:
        name: pdf-outputs
        path: qmd/*.pdf
        retention-days: 7